---
tags:
  - Multithreading
  - Problem
---
### Описание
**Взаимная блокировка** (сокращённо **взаимоблокировка**, _deadlock_) — ситуация в многозадачной среде или СУБД, при которой несколько процессов находятся в состоянии ожидания ресурсов, занятых друг другом, и ни один из них не может продолжать свое выполнение.

### Примеры
Самый простой пример – запланировать выполнение задачи из serial очереди синхронно на той же самой очереди:
```swift
let serialQueue = DispatchQueue(label: "ru.anyname.serial-queue")

print("Start")

serialQueue.sync {    
	serialQueue.sync {        
		print("Deadlock")    
	}
}
print("Finish")
```
`serialQueue` никогда не вернет управление главной очереди, так как она будет бесконечно ожидать возврата управления от самой себя. Решить проблему можно двумя способами:
```swift
serialQueue.sync {    
	serialQueue.async {        
		// ...    
	}
}
```
Управление в очередь `serialQueue` вернется немедленно, что позволит ей продолжить работу и выполнение задач на своем потоке. Так или иначе задачи будут выполняться последовательно и если у нас нет потребности в использовании последовательной очереди, проблему можно решить использованием параллельной очереди:
```swift
let concurrentQueue = DispatchQueue(label: "ru.anyname.concurrent-queue",
									attributes: .concurrent)

print("Start")

concurrentQueue.sync {    
	concurrentQueue.sync {        
		print("No deadlock")    
	}
}

print("Finish")
```
В данном случае `concurrentQueue` не будет бесконечно ожидать возвращение управления, так как задачи будут выполняться на разных потоках. 

Исходя из всего вышеперечисленного можно сделать несколько выводов:
- Стоит избегать сложные вложенные планирования задач на одной последовательной очереди
- Вызов sync у последовательно очереди из той же очереди всегда приведет к взаимной блокировке